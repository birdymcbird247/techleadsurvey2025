<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI in Education: Tech Lead Comfort Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .question-card {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .hidden-question {
            transform: translateX(100%);
            opacity: 0;
            position: absolute;
            width: 100%;
        }
        .visible-question {
            transform: translateX(0);
            opacity: 1;
        }
        .progress-bar-fill {
            transition: width 0.3s ease-in-out;
        }
        .option-button {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .option-button.selected {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border-color: #3b82f6; /* border-blue-600 */
        }
        .results-chart-container {
            height: 300px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI in Education Survey</h1>
            <p class="mt-2 text-lg text-gray-600">For Technology Leaders and Administrators</p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-4"></p>
        </header>

        <!-- Survey Section -->
        <div id="survey-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-blue-700">Progress</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-700"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questions-container" class="relative overflow-hidden min-h-[350px]">
                <!-- Questions will be injected here by JavaScript -->
            </div>

            <!-- Navigation Buttons -->
            <div class="mt-8 flex justify-between items-center">
                <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Previous
                </button>
                <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Next
                </button>
                <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 hidden">
                    Submit & See Results
                </button>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="text-center p-8 hidden">
             <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
             <p class="mt-4 text-gray-600">Submitting and crunching the numbers...</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden mt-12">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-8">Survey Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Charts will be injected here -->
            </div>
             <div class="mt-8 text-center">
                <button id="retake-survey-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    Retake Survey
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-survey-app';
        
        // --- FIREBASE INITIALIZATION ---
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // setLogLevel('debug'); // Uncomment for detailed logs
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('app-container').innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline"> Could not connect to the database. Please check the console for details.</span></div>`;
        }

        // --- SURVEY QUESTIONS ---
        const questions = [
            {
                id: 'comfortLevel',
                text: 'On a scale of 1-5, how comfortable are you with integrating AI tools into the classroom?',
                type: 'rating',
                options: [1, 2, 3, 4, 5],
                labels: { 1: 'Very Uncomfortable', 5: 'Very Comfortable' }
            },
            {
                id: 'aiApplications',
                text: 'Which AI applications are you most interested in for your school/district? (Select up to 3)',
                type: 'multiple-choice',
                limit: 3,
                options: ['Personalized Learning Paths', 'Automated Grading & Feedback', 'AI Tutors for Students', 'Content Generation for Teachers', 'Student Performance Analytics', 'Administrative Automation']
            },
            {
                id: 'biggestConcern',
                text: 'What is your biggest concern regarding AI in education?',
                type: 'single-choice',
                options: ['Data Privacy & Security', 'Ethical Implications & Bias', 'Student Cheating & Academic Integrity', 'Teacher Training & Adoption', 'Cost & Equity of Access', 'Potential for Job Displacement']
            },
            {
                id: 'schoolReadiness',
                text: 'How prepared is your school/district to adopt AI technologies?',
                type: 'rating',
                options: [1, 2, 3, 4, 5],
                labels: { 1: 'Not at all prepared', 5: 'Very prepared' }
            },
            {
                id: 'neededSupport',
                text: 'What is the most critical support needed for successful AI integration?',
                type: 'single-choice',
                options: ['Professional Development for Staff', 'Clear Policies & Guidelines', 'Vetted & Approved AI Tools', 'Funding for Technology', 'Technical Support & Infrastructure']
            }
        ];

        // --- STATE MANAGEMENT ---
        let currentQuestionIndex = 0;
        let userAnswers = {};

        // --- DOM ELEMENTS ---
        const surveySection = document.getElementById('survey-section');
        const resultsSection = document.getElementById('results-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const questionsContainer = document.getElementById('questions-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const retakeSurveyBtn = document.getElementById('retake-survey-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `Your anonymous ID: ${userId}`;
                initializeSurvey();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    userIdDisplay.textContent = "Could not establish a secure session.";
                }
            }
        });

        // --- FUNCTIONS ---

        function initializeSurvey() {
            currentQuestionIndex = 0;
            userAnswers = {};
            surveySection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            submitBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            renderQuestions();
            updateDisplay();
        }
        
        function renderQuestions() {
            questionsContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.id = `question-${index}`;
                questionEl.className = 'question-card p-2';
                questionEl.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">${q.text}</h3>
                    <div class="space-y-3" id="options-${index}"></div>
                `;
                questionsContainer.appendChild(questionEl);
                renderOptions(q, index);
            });
        }

        function renderOptions(question, index) {
            const optionsContainer = document.getElementById(`options-${index}`);
            if (question.type === 'rating') {
                const ratingContainer = document.createElement('div');
                ratingContainer.className = 'flex justify-between items-center flex-wrap gap-2';
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'option-button w-12 h-12 sm:w-14 sm:h-14 flex items-center justify-center border-2 border-gray-300 rounded-full font-semibold text-lg hover:bg-blue-100';
                    button.dataset.value = option;
                    button.onclick = () => handleAnswer(question.id, option, 'rating');
                    ratingContainer.appendChild(button);
                });
                optionsContainer.appendChild(ratingContainer);
                const labelsContainer = document.createElement('div');
                labelsContainer.className = 'flex justify-between text-sm text-gray-500 mt-2';
                labelsContainer.innerHTML = `<span>${question.labels[1]}</span><span>${question.labels[5]}</span>`;
                optionsContainer.appendChild(labelsContainer);
            } else {
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'option-button w-full text-left p-4 border-2 border-gray-300 rounded-lg hover:bg-blue-100';
                    button.dataset.value = option;
                    button.onclick = () => handleAnswer(question.id, option, question.type, question.limit);
                    optionsContainer.appendChild(button);
                });
            }
        }

        function handleAnswer(questionId, value, type, limit = 1) {
            if (type === 'multiple-choice') {
                if (!userAnswers[questionId]) {
                    userAnswers[questionId] = [];
                }
                const answerArray = userAnswers[questionId];
                const valueIndex = answerArray.indexOf(value);
                if (valueIndex > -1) {
                    answerArray.splice(valueIndex, 1);
                } else {
                    if (answerArray.length < limit) {
                        answerArray.push(value);
                    } else {
                         // Optional: Add user feedback that limit is reached
                        console.log(`Limit of ${limit} reached for ${questionId}`);
                    }
                }
            } else { // single-choice or rating
                userAnswers[questionId] = value;
            }
            updateOptionsUI(questionId);
            updateNavigation();
        }
        
        function updateOptionsUI(questionId) {
            const question = questions.find(q => q.id === questionId);
            const index = questions.findIndex(q => q.id === questionId);
            const optionsContainer = document.getElementById(`options-${index}`);
            const buttons = optionsContainer.querySelectorAll('.option-button');
            
            buttons.forEach(button => {
                const value = button.dataset.value;
                let isSelected = false;
                if (Array.isArray(userAnswers[questionId])) {
                    isSelected = userAnswers[questionId].includes(value);
                } else {
                    // For rating, we convert the dataset value back to a number for comparison
                    isSelected = question.type === 'rating' ? parseInt(userAnswers[questionId]) === parseInt(value) : userAnswers[questionId] === value;
                }
                
                if (isSelected) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }


        function updateDisplay() {
            // Update question visibility
            document.querySelectorAll('.question-card').forEach((card, index) => {
                if (index === currentQuestionIndex) {
                    card.classList.remove('hidden-question');
                    card.classList.add('visible-question');
                } else {
                    card.classList.add('hidden-question');
                    card.classList.remove('visible-question');
                }
            });

            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;

            updateNavigation();
        }
        
        function updateNavigation() {
             // Update button states
            prevBtn.disabled = currentQuestionIndex === 0;

            const currentQuestionId = questions[currentQuestionIndex].id;
            const isAnswered = userAnswers[currentQuestionId] && (Array.isArray(userAnswers[currentQuestionId]) ? userAnswers[currentQuestionId].length > 0 : userAnswers[currentQuestionId] !== undefined);
            nextBtn.disabled = !isAnswered;

            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                submitBtn.disabled = !isAnswered;
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
        }

        async function submitSurvey() {
            surveySection.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/responses`), {
                    ...userAnswers,
                    submittedAt: new Date(),
                    userId: userId
                });
                console.log("Document written with ID: ", docRef.id);
                await showResults();
            } catch (e) {
                console.error("Error adding document: ", e);
                loadingSpinner.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert"><strong class="font-bold">Submission Failed!</strong><span class="block sm:inline"> Could not save your response. Please try again later.</span></div>`;
            }
        }

        async function showResults() {
            loadingSpinner.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            resultsSection.querySelector('.grid').innerHTML = '<p class="text-center md:col-span-2">Loading results...</p>';

            try {
                const querySnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/responses`));
                const allResponses = [];
                querySnapshot.forEach((doc) => {
                    allResponses.push(doc.data());
                });

                if(allResponses.length === 0) {
                    resultsSection.querySelector('.grid').innerHTML = '<p class="text-center md:col-span-2">No results to display yet. You are the first respondent!</p>';
                    return;
                }

                generateCharts(allResponses);

            } catch(e) {
                console.error("Error fetching results: ", e);
                resultsSection.querySelector('.grid').innerHTML = `<p class="text-center text-red-600 md:col-span-2">Could not load aggregated results.</p>`;
            }
        }

        function generateCharts(data) {
            const resultsGrid = resultsSection.querySelector('.grid');
            resultsGrid.innerHTML = ''; // Clear previous charts

            questions.forEach(q => {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'bg-white p-4 rounded-lg shadow';
                const chartTitle = document.createElement('h3');
                chartTitle.className = 'text-lg font-semibold mb-2 text-center';
                chartTitle.textContent = q.text;
                const canvasContainer = document.createElement('div');
                canvasContainer.className = 'results-chart-container';
                const canvas = document.createElement('canvas');
                canvasContainer.appendChild(canvas);
                chartContainer.appendChild(chartTitle);
                chartContainer.appendChild(canvasContainer);
                resultsGrid.appendChild(chartContainer);

                const ctx = canvas.getContext('2d');
                let chartData, chartType;

                if (q.type === 'rating' || q.type === 'single-choice') {
                    const counts = q.options.reduce((acc, option) => {
                        acc[option] = 0;
                        return acc;
                    }, {});
                    data.forEach(response => {
                        if (response[q.id]) {
                            counts[response[q.id]]++;
                        }
                    });
                    chartData = {
                        labels: Object.keys(counts),
                        datasets: [{
                            label: 'Number of Responses',
                            data: Object.values(counts),
                            backgroundColor: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e3a8a', '#1e40af'],
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1
                        }]
                    };
                    chartType = 'bar';
                } else if (q.type === 'multiple-choice') {
                     const counts = q.options.reduce((acc, option) => {
                        acc[option] = 0;
                        return acc;
                    }, {});
                    data.forEach(response => {
                        if (response[q.id] && Array.isArray(response[q.id])) {
                           response[q.id].forEach(choice => {
                               if(counts.hasOwnProperty(choice)) {
                                   counts[choice]++;
                               }
                           });
                        }
                    });
                     chartData = {
                        labels: Object.keys(counts),
                        datasets: [{
                            label: 'Number of Selections',
                            data: Object.values(counts),
                            backgroundColor: ['#818cf8', '#6366f1', '#4f46e5', '#4338ca', '#3730a3', '#312e81'],
                        }]
                    };
                    chartType = 'doughnut';
                }
                
                new Chart(ctx, {
                    type: chartType,
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: chartType === 'doughnut' ? 'top' : 'none',
                            },
                        },
                        scales: chartType === 'bar' ? { y: { beginAtZero: true, ticks: { precision: 0 } } } : {}
                    }
                });
            });
        }

        // --- EVENT LISTENERS ---
        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                updateDisplay();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                updateDisplay();
            }
        });

        submitBtn.addEventListener('click', submitSurvey);
        retakeSurveyBtn.addEventListener('click', initializeSurvey);

    </script>
</body>
</html>
